# ✅ EF Core Entity & Migration Regeneration Guide  
**Location:** `.github/copilot-entity-generation.md`  
**Purpose:** Instructions for GitHub Copilot or developers to regenerate EF Core entities, configurations, and migrations from MySQL database.

---

## ✅ 1. Database Connection

The updated MySQL database uses this connection string:

```
ConnectionStrings__downstairsdb = Server=localhost;Port=3306;Database=downstairs;Uid=root;Pwd=password;CharSet=utf8mb4;
```

---

## ✅ 2. Required Actions

Follow these steps when regenerating EF Core models and migrations:

### **Step 1 — Clean Up Existing Code**
- Remove all existing EF Core entities (`/Models`) and previous migrations.
- Remove or clear old configuration classes in `/EntityConfigurations`.

---

### **Step 2 — Scaffold New Models from Database**
Use EF Core database-first scaffolding to generate new entities and `DbContext` from the database schema.

---

### **Step 3 — Correct Data Type Mappings**

Apply the following data type rules during or after scaffolding:

#### **C# Type Mappings**
| MySQL Type                     | C# Type |
|--------------------------------|---------|
| UNSIGNED BIGINT / UNSIGNED INT | `long`  |
| `ulong` (if generated by EF)   | Replace with `long` |

#### **SQL Column Type Rules in Configuration (`IEntityTypeConfiguration<T>`)**
| MySQL Column         | Use in `.HasColumnType(...)` |
|----------------------|------------------------------|
| `smallint`           | `smallint unsigned`          |
| `tinyint`            | `tinyint unsigned`           |
| `decimal(8,2)`       | `decimal(8,2) unsigned`      |

Example inside a configuration file:

```csharp
builder.Property(x => x.Status).HasColumnType("tinyint unsigned");
builder.Property(x => x.Level).HasColumnType("smallint unsigned");
builder.Property(x => x.Price).HasColumnType("decimal(8,2) unsigned");
```

---

### **Step 4 — Configure Many-to-Many Table Names**

**CRITICAL:** EF Core generates incorrect table names for many-to-many relationships. Always configure them explicitly:

#### **Required Many-to-Many Configurations:**

**Permission ↔ Role:** Table name must be `role_has_permissions`
```csharp
// In PermissionConfiguration.cs
entity.HasMany(p => p.Roles)
    .WithMany(r => r.Permissions)
    .UsingEntity(
        "role_has_permissions",
        l => l.HasOne(typeof(Role)).WithMany().HasForeignKey("role_id").HasPrincipalKey(nameof(Role.Id)),
        r => r.HasOne(typeof(Permission)).WithMany().HasForeignKey("permission_id").HasPrincipalKey(nameof(Permission.Id)),
        j => j.HasKey("role_id", "permission_id"));
```

**FixedPrice ↔ Product:** Table name must be `fixed_price_laundry_products`
```csharp
// In FixedPriceConfiguration.cs
entity.HasMany(f => f.Products)
    .WithMany(p => p.FixedPrices)
    .UsingEntity(
        "fixed_price_laundry_products",
        l => l.HasOne(typeof(Product)).WithMany().HasForeignKey("product_id").HasPrincipalKey(nameof(Product.Id)),
        r => r.HasOne(typeof(FixedPrice)).WithMany().HasForeignKey("fixed_price_id").HasPrincipalKey(nameof(FixedPrice.Id)),
        j => j.HasKey("fixed_price_id", "product_id"));
```

**OrderFixedPrice ↔ Product:** Table name must be `order_fixed_price_laundry_products`
```csharp
// In OrderFixedPriceConfiguration.cs
entity.HasMany(o => o.Products)
    .WithMany(p => p.OrderFixedPrices)
    .UsingEntity(
        "order_fixed_price_laundry_products",
        l => l.HasOne(typeof(Product)).WithMany().HasForeignKey("product_id").HasPrincipalKey(nameof(Product.Id)),
        r => r.HasOne(typeof(OrderFixedPrice)).WithMany().HasForeignKey("order_fixed_price_id").HasPrincipalKey(nameof(OrderFixedPrice.Id)),
        j => j.HasKey("order_fixed_price_id", "product_id"));
```

---

### **Step 5 — Apply Charset & Collation Globally**

In `DownstairsDbContext.OnModelCreating`:

```csharp
modelBuilder.UseCollation(DatabaseConstants.Collations.Unicode);
modelBuilder.HasCharSet(DatabaseConstants.CharSets.Utf8mb4);
modelBuilder.ApplyConfigurationsFromAssembly(typeof(DownstairsDbContext).Assembly);
```

In each `IEntityTypeConfiguration<T>` file:

```csharp
builder.UseCollation(DatabaseConstants.Collations.Unicode);
builder.HasCharSet(DatabaseConstants.CharSets.Utf8mb4);
```

---

### **Step 6 — Store Configuration Files in Separate Files**

- Each class implementing `IEntityTypeConfiguration<T>` must be placed in its own file.
- Suggested folder: `/EntityConfigurations/`.

```
/EntityConfigurations
   ProductConfiguration.cs
   OrderConfiguration.cs
   UserConfiguration.cs
```

---

### **Step 7 — Create Migration**
After entities and configurations are ready:

```
dotnet ef migrations add InitialCreate
```

**IMPORTANT:** After creating the migration, manually verify and fix decimal columns to include `unsigned`:
- Change `decimal(8,2)` to `decimal(8,2) unsigned` in migration file
- EF Core may not generate the unsigned keyword correctly

---

### **Step 8 — Apply `.editorconfig` Formatting**
Run:

```
dotnet format
```

Ensure:
✔ Naming conventions  
✔ Indentation and spacing  
✔ Braces and layout rules are applied to all files  

---

### **Step 9 — Build Verification**
- Run `dotnet build`
- Ensure the solution compiles successfully and migrations work

---

### ✅ Done!

This file ensures consistency every time EF Core entities are regenerated or synchronized with the database schema.

---
